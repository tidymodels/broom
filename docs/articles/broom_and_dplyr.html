<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>broom and dplyr • broom</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- tidyverse --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">broom</a>
        <small class="tidyverse">part of the <a href="http://tidyverse.org">tidyverse</a></small>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/broom.html">Intro</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/adding-tidiers.html">Adding new tidiers</a>
    </li>
    <li>
      <a href="../articles/available-methods.html">Available methods</a>
    </li>
    <li>
      <a href="../articles/bootstrapping.html">Bootstrapping</a>
    </li>
    <li>
      <a href="../articles/broom_and_dplyr.html">Broom and dplyr</a>
    </li>
    <li>
      <a href="../articles/kmeans.html">K-means</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
        <li>
  <a href="https://github.com/tidyverse/broom">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>broom and dplyr</h1>
            
            <h4 class="date">2018-06-07</h4>
      
      <small class="dont-index">Source: <a href="http://github.com/tidyverse/broom/blob/master/vignettes/broom_and_dplyr.Rmd"><code>vignettes/broom_and_dplyr.Rmd</code></a></small>
      <div class="hidden name"><code>broom_and_dplyr.Rmd</code></div>

    </div>

    
    
<div id="broom-and-dplyr" class="section level1">
<h1 class="hasAnchor">
<a href="#broom-and-dplyr" class="anchor"></a>broom and dplyr</h1>
<p>While broom is useful for summarizing the result of a single analysis in a consistent format, it is really designed for high-throughput applications, where you must combine results from multiple analyses. These could be subgroups of data, analyses using different models, bootstrap replicates, permutations, and so on. In particular, it plays well with the <code>group_by</code> and <code>do</code> functions in <code>dplyr</code>.</p>
<p>Let’s try this on a simple dataset, the built-in <code>Orange</code> data.frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(broom)
<span class="kw">library</span>(dplyr)
<span class="kw">data</span>(Orange)

<span class="kw">dim</span>(Orange)</code></pre></div>
<pre><code>## [1] 35  3</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(Orange)</code></pre></div>
<pre><code>## Grouped Data: circumference ~ age | Tree
##   Tree  age circumference
## 1    1  118            30
## 2    1  484            58
## 3    1  664            87
## 4    1 1004           115
## 5    1 1231           120
## 6    1 1372           142</code></pre>
<p>This contains 35 observations of three variables: <code>Tree</code>, <code>age</code>, and <code>circumference</code>. <code>Tree</code> is a factor with five levels describing five trees. As might be expected, age and circumference are correlated:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cor</span>(Orange<span class="op">$</span>age, Orange<span class="op">$</span>circumference)</code></pre></div>
<pre><code>## [1] 0.9135189</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(Orange, <span class="kw">aes</span>(age, circumference, <span class="dt">color =</span> Tree)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</code></pre></div>
<p><img src="broom_and_dplyr_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<p>Suppose you want to test for correlations individually <em>within</em> each tree. You can do this with dplyr’s <code>group_by</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Orange <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Tree) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">correlation =</span> <span class="kw">cor</span>(age, circumference))</code></pre></div>
<pre><code>## # A tibble: 5 x 2
##   Tree  correlation
##   &lt;ord&gt;       &lt;dbl&gt;
## 1 3           0.988
## 2 1           0.985
## 3 5           0.988
## 4 2           0.987
## 5 4           0.984</code></pre>
<p>(Note that the correlations are much higher than the aggregated one, and furthermore we can now see it is similar across trees).</p>
<p>Suppose that instead of simply estimating a correlation, we want to perform a hypothesis test with <code>cor.test</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cor.test</span>(Orange<span class="op">$</span>age, Orange<span class="op">$</span>circumference)</code></pre></div>
<pre><code>## 
##  Pearson's product-moment correlation
## 
## data:  Orange$age and Orange$circumference
## t = 12.9, df = 33, p-value = 1.931e-14
## alternative hypothesis: true correlation is not equal to 0
## 95 percent confidence interval:
##  0.8342364 0.9557955
## sample estimates:
##       cor 
## 0.9135189</code></pre>
<p>This contains multiple values we could want in our output. Some are vectors of length 1, such as the p-value and the estimate, and some are longer, such as the confidence interval. broom’s <code>tidy</code> S3 method, combined with dplyr’s <code>do</code>, makes it easy to summarize the information about each test:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Orange <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Tree) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">do</span>(<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(<span class="kw">cor.test</span>(.<span class="op">$</span>age, .<span class="op">$</span>circumference)))</code></pre></div>
<pre><code>## # A tibble: 5 x 9
## # Groups:   Tree [5]
##   Tree  estimate statistic  p.value parameter conf.low conf.high method   
##   &lt;ord&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;int&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;    
## 1 3        0.988      14.4  2.90e-5         5    0.919     0.998 Pearson'~
## 2 1        0.985      13.0  4.85e-5         5    0.901     0.998 Pearson'~
## 3 5        0.988      14.1  3.18e-5         5    0.916     0.998 Pearson'~
## 4 2        0.987      13.9  3.43e-5         5    0.914     0.998 Pearson'~
## 5 4        0.984      12.5  5.73e-5         5    0.895     0.998 Pearson'~
## # ... with 1 more variable: alternative &lt;fct&gt;</code></pre>
<p>This becomes even more useful when applied to regressions, which give more than one row of output within each model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Orange <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Tree) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">do</span>(<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(<span class="kw">lm</span>(age <span class="op">~</span><span class="st"> </span>circumference, <span class="dt">data=</span>.)))</code></pre></div>
<pre><code>## # A tibble: 10 x 6
## # Groups:   Tree [5]
##    Tree  term          estimate std.error statistic   p.value
##    &lt;ord&gt; &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
##  1 3     (Intercept)    -210.      85.3      -2.46  0.0574   
##  2 3     circumference    12.0      0.835    14.4   0.0000290
##  3 1     (Intercept)    -265.      98.6      -2.68  0.0436   
##  4 1     circumference    11.9      0.919    13.0   0.0000485
##  5 5     (Intercept)     -54.5     76.9      -0.709 0.510    
##  6 5     circumference     8.79     0.621    14.1   0.0000318
##  7 2     (Intercept)    -132.      83.1      -1.59  0.172    
##  8 2     circumference     7.80     0.560    13.9   0.0000343
##  9 4     (Intercept)     -76.5     88.3      -0.867 0.426    
## 10 4     circumference     7.17     0.572    12.5   0.0000573</code></pre>
<p>You can just as easily perform multiple regressions within each group, as shown here on the <code>mtcars</code> dataset. We group the data into automatic and manual cars (the <code>am</code> column), then perform the regression within each.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(mtcars)
<span class="kw">head</span>(mtcars)</code></pre></div>
<pre><code>##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb
## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(am) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">do</span>(<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(<span class="kw">lm</span>(wt <span class="op">~</span><span class="st"> </span>mpg <span class="op">+</span><span class="st"> </span>qsec <span class="op">+</span><span class="st"> </span>gear, .)))</code></pre></div>
<pre><code>## # A tibble: 8 x 6
## # Groups:   am [2]
##      am term        estimate std.error statistic  p.value
##   &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1     0 (Intercept)   4.92      1.40      3.52   0.00309 
## 2     0 mpg          -0.192     0.0443   -4.33   0.000591
## 3     0 qsec          0.0919    0.0983    0.935  0.365   
## 4     0 gear          0.147     0.368     0.398  0.696   
## 5     1 (Intercept)   4.28      3.46      1.24   0.247   
## 6     1 mpg          -0.101     0.0294   -3.43   0.00750 
## 7     1 qsec          0.0398    0.151     0.264  0.798   
## 8     1 gear         -0.0229    0.349    -0.0656 0.949</code></pre>
<p>What if you want not just the <code>tidy</code> output, but the <code>augment</code> and <code>glance</code> outputs as well, while still performing each regression only once? First, save the modeling result into a column <code>fit</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">regressions &lt;-<span class="st"> </span>mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(cyl) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">do</span>(<span class="dt">fit =</span> <span class="kw">lm</span>(wt <span class="op">~</span><span class="st"> </span>mpg <span class="op">+</span><span class="st"> </span>qsec <span class="op">+</span><span class="st"> </span>gear, .))
regressions</code></pre></div>
<pre><code>## Source: local data frame [3 x 2]
## Groups: &lt;by row&gt;
## 
## # A tibble: 3 x 2
##     cyl fit     
## * &lt;dbl&gt; &lt;list&gt;  
## 1     4 &lt;S3: lm&gt;
## 2     6 &lt;S3: lm&gt;
## 3     8 &lt;S3: lm&gt;</code></pre>
<p>This creates a rowwise data frame. Tidying methods are designed to work seamlessly with rowwise data frames, grouping them and performing tidying on each row:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">regressions <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/tidy.html">tidy</a></span>(fit)</code></pre></div>
<pre><code>## # A tibble: 12 x 6
## # Groups:   cyl [3]
##      cyl term        estimate std.error statistic p.value
##    &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
##  1     4 (Intercept) -0.773      2.23    -0.347   0.739  
##  2     4 mpg         -0.0818     0.0238  -3.44    0.0109 
##  3     4 qsec         0.217      0.0759   2.85    0.0245 
##  4     4 gear         0.267      0.245    1.09    0.310  
##  5     6 (Intercept) -7.79       3.35    -2.32    0.103  
##  6     6 mpg          0.0433     0.0520   0.833   0.466  
##  7     6 qsec         0.422      0.0914   4.62    0.0191 
##  8     6 gear         0.638      0.205    3.11    0.0529 
##  9     8 (Intercept)  0.00597    4.27     0.00140 0.999  
## 10     8 mpg         -0.177      0.0557  -3.18    0.00989
## 11     8 qsec         0.369      0.193    1.91    0.0848 
## 12     8 gear         0.143      0.317    0.451   0.662</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">regressions <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/augment.html">augment</a></span>(fit)</code></pre></div>
<pre><code>## # A tibble: 32 x 12
## # Groups:   cyl [3]
##      cyl    wt   mpg  qsec  gear .fitted .se.fit    .resid  .hat .sigma
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
##  1     4  2.32  22.8  18.6     4    2.46   0.142 -0.143    0.197  0.339
##  2     4  3.19  24.4  20       4    2.63   0.120  0.556    0.141  0.243
##  3     4  3.15  22.8  22.9     4    3.39   0.299 -0.243    0.876  0.199
##  4     4  2.2   32.4  19.5     4    1.86   0.174  0.336    0.296  0.304
##  5     4  1.62  30.4  18.5     4    1.82   0.148 -0.207    0.213  0.332
##  6     4  1.84  33.9  19.9     4    1.83   0.210  0.000505 0.432  0.345
##  7     4  2.46  21.5  20.0     3    2.61   0.249 -0.141    0.610  0.332
##  8     4  1.94  27.3  18.9     4    2.16   0.105 -0.223    0.107  0.331
##  9     4  2.14  26    16.7     5    2.06   0.218  0.0849   0.464  0.342
## 10     4  1.51  30.4  16.9     5    1.74   0.201 -0.225    0.396  0.324
## # ... with 22 more rows, and 2 more variables: .cooksd &lt;dbl&gt;,
## #   .std.resid &lt;dbl&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">regressions <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/glance.html">glance</a></span>(fit)</code></pre></div>
<pre><code>## # A tibble: 3 x 12
## # Groups:   cyl [3]
##     cyl r.squared adj.r.squared  sigma statistic p.value    df  logLik
##   &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
## 1     4     0.780         0.686 0.319       8.27 0.0106      4  -0.567
## 2     6     0.970         0.940 0.0873     32.3  0.00874     4  10.1  
## 3     8     0.652         0.548 0.511       6.25 0.0116      4  -8.10 
## # ... with 4 more variables: AIC &lt;dbl&gt;, BIC &lt;dbl&gt;, deviance &lt;dbl&gt;,
## #   df.residual &lt;int&gt;</code></pre>
<p>By combining the estimates and p-values across all groups into the same tidy data frame (instead of, for example, a list of output model objects), a new class of analyses and visualizations becomes straightforward. This includes</p>
<ul>
<li>Sorting by p-value or estimate to find the most significant terms across all tests</li>
<li>P-value histograms</li>
<li>Volcano plots comparing p-values to effect size estimates</li>
</ul>
<p>In each of these cases, we can easily filter, facet, or distinguish based on the <code>term</code> column. In short, this makes the tools of tidy data analysis available for the <em>results</em> of data analysis and models, not just the inputs.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#broom-and-dplyr">broom and dplyr</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="tidyverse">
  <p>broom is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="http://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>Developed by David Robinson.</p>
  <p>Site built by <a href="http://pkgdown.r-lib.org">pkgdown</a>.</p>
</div>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-115082821-1');
</script></footer>
</div>

  

  </body>
</html>
