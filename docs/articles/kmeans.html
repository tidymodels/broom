<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>kmeans with dplyr and broom • broom</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- tidyverse --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">broom</a>
        <small class="tidyverse">part of the <a href="http://tidyverse.org">tidyverse</a></small>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/broom.html">Intro</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/adding-tidiers.html">Adding new tidiers</a>
    </li>
    <li>
      <a href="../articles/available-methods.html">Available methods</a>
    </li>
    <li>
      <a href="../articles/bootstrapping.html">Bootstrapping</a>
    </li>
    <li>
      <a href="../articles/broom_and_dplyr.html">Broom and dplyr</a>
    </li>
    <li>
      <a href="../articles/kmeans.html">K-means</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
        <li>
  <a href="https://github.com/tidyverse/broom">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>kmeans with dplyr and broom</h1>
            
            <h4 class="date">2018-06-07</h4>
      
      <small class="dont-index">Source: <a href="http://github.com/tidyverse/broom/blob/master/vignettes/kmeans.Rmd"><code>vignettes/kmeans.Rmd</code></a></small>
      <div class="hidden name"><code>kmeans.Rmd</code></div>

    </div>

    
    
<div id="tidying-k-means-clustering" class="section level1">
<h1 class="hasAnchor">
<a href="#tidying-k-means-clustering" class="anchor"></a>Tidying k-means clustering</h1>
<p>K-means clustering serves as a very useful example of tidy data, and especially the distinction between the three tidying functions: <code>tidy</code>, <code>augment</code>, and <code>glance</code>.</p>
<p>Let’s start by generating some random 2d data with three clusters, within which points are distributed according to a multivariate gaussian:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)

<span class="kw">set.seed</span>(<span class="dv">2014</span>)
centers &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">cluster=</span><span class="kw">factor</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="dt">size=</span><span class="kw">c</span>(<span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">50</span>), <span class="dt">x1=</span><span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">0</span>, <span class="op">-</span><span class="dv">3</span>), <span class="dt">x2=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="op">-</span><span class="dv">2</span>))
points &lt;-<span class="st"> </span>centers <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(cluster) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">do</span>(<span class="kw">data.frame</span>(<span class="dt">x1=</span><span class="kw">rnorm</span>(.<span class="op">$</span>size[<span class="dv">1</span>], .<span class="op">$</span>x1[<span class="dv">1</span>]),
                  <span class="dt">x2=</span><span class="kw">rnorm</span>(.<span class="op">$</span>size[<span class="dv">1</span>], .<span class="op">$</span>x2[<span class="dv">1</span>])))

<span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(points, <span class="kw">aes</span>(x1, x2, <span class="dt">color=</span>cluster)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</code></pre></div>
<p><img src="kmeans_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>This is an ideal case for k-means clustering. Let’s examine what the built-in <code>kmeans</code> function returns.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">points.matrix &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dt">x1 =</span> points<span class="op">$</span>x1, <span class="dt">x2 =</span> points<span class="op">$</span>x2)
kclust &lt;-<span class="st"> </span><span class="kw">kmeans</span>(points.matrix, <span class="dv">3</span>)
kclust</code></pre></div>
<pre><code>## K-means clustering with 3 clusters of sizes 99, 151, 50
## 
## Cluster means:
##           x1         x2
## 1  5.1791917 -0.9865170
## 2  0.1583797  0.9797098
## 3 -3.0653196 -2.0887225
## 
## Clustering vector:
##   [1] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
##  [36] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1
##  [71] 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2
## [106] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
## [141] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
## [176] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
## [211] 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
## [246] 2 2 2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3
## [281] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3
## 
## Within cluster sum of squares by cluster:
## [1] 204.96483 257.20360  78.64255
##  (between_SS / total_SS =  85.1 %)
## 
## Available components:
## 
## [1] "cluster"      "centers"      "totss"        "withinss"    
## [5] "tot.withinss" "betweenss"    "size"         "iter"        
## [9] "ifault"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(kclust)</code></pre></div>
<pre><code>##              Length Class  Mode   
## cluster      300    -none- numeric
## centers        6    -none- numeric
## totss          1    -none- numeric
## withinss       3    -none- numeric
## tot.withinss   1    -none- numeric
## betweenss      1    -none- numeric
## size           3    -none- numeric
## iter           1    -none- numeric
## ifault         1    -none- numeric</code></pre>
<p>The output is a list of vectors, where each component has a different length. There’s one of length 300: the same as our original dataset. There are a number of elements of length 3: <code>withinss</code>, <code>tot.withinss</code>, and <code>betweenss</code>- and <code>centers</code> is a matrix with 3 rows. And then there are the elements of length 1: <code>totss</code>, <code>tot.withinss</code>, <code>betweenss</code>, and <code>iter</code>.</p>
<p>These differing lengths have a deeper meaning when we want to tidy our dataset: they signify that each type of component communicates a <em>different kind</em> of information.</p>
<ul>
<li>
<code>cluster</code> (300 values) contains information about each <em>point</em>
</li>
<li>
<code>centers</code>, <code>withinss</code> and <code>size</code> (3 values) contain information about each <em>cluster</em>
</li>
<li>
<code>totss</code>, <code>tot.withinss</code>, <code>betweenss</code>, and <code>iter</code> (1 value) contain information about the <em>full clustering</em>
</li>
</ul>
<p>Which of these do we want to extract? There is no right answer: each of them may be interesting to an analyst. Because they communicate entirely different information (not to mention there’s no straightforward way to combine them), they are extracted by separate functions. <code>augment</code> adds the point classifications to the original dataset:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(broom)
<span class="kw">head</span>(<span class="kw"><a href="../reference/augment.html">augment</a></span>(kclust, points.matrix))</code></pre></div>
<pre><code>##         x1         x2 .cluster
## 1 4.434320  0.5416470        1
## 2 5.321046 -0.9412882        1
## 3 5.125271 -1.5802282        1
## 4 6.353225 -1.6040549        1
## 5 3.712270 -3.4079344        1
## 6 5.322555 -0.7716317        1</code></pre>
<p>The <code>tidy</code> function summarizes on a per-cluster level:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/tidy.html">tidy</a></span>(kclust)</code></pre></div>
<pre><code>##           x1         x2 size  withinss cluster
## 1  5.1791917 -0.9865170   99 204.96483       1
## 2  0.1583797  0.9797098  151 257.20360       2
## 3 -3.0653196 -2.0887225   50  78.64255       3</code></pre>
<p>And as it always does, the <code>glance</code> function extracts a single-row summary:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/glance.html">glance</a></span>(kclust)</code></pre></div>
<pre><code>##     totss tot.withinss betweenss iter
## 1 3629.67      540.811  3088.859    2</code></pre>
<div id="broom-and-dplyr-for-exploratory-clustering" class="section level2">
<h2 class="hasAnchor">
<a href="#broom-and-dplyr-for-exploratory-clustering" class="anchor"></a>broom and dplyr for exploratory clustering</h2>
<p>While these summaries are useful, they would not have been too difficult to extract out from the dataset yourself. The real power comes from combining their analyses with dplyr.</p>
<p>Let’s say we want to explore the effect of different choices of <code>k</code>, from 1 to 9, on this clustering. First cluster the data 9 times, each using a different value of k:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">kclusts &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">k=</span><span class="dv">1</span><span class="op">:</span><span class="dv">9</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(k) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">do</span>(<span class="dt">kclust=</span><span class="kw">kmeans</span>(points.matrix, .<span class="op">$</span>k))</code></pre></div>
<p>Then tidy the clusterings three ways: using <code>tidy</code>, using <code>augment</code>, and using <code>glance</code>. Each of these goes into a separate dataset as they represent different types of data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">clusters &lt;-<span class="st"> </span>kclusts <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(k) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">do</span>(<span class="kw"><a href="../reference/tidy.html">tidy</a></span>(.<span class="op">$</span>kclust[[<span class="dv">1</span>]]))
assignments &lt;-<span class="st"> </span>kclusts <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(k) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">do</span>(<span class="kw"><a href="../reference/augment.html">augment</a></span>(.<span class="op">$</span>kclust[[<span class="dv">1</span>]], points.matrix))
clusterings &lt;-<span class="st"> </span>kclusts <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(k) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">do</span>(<span class="kw"><a href="../reference/glance.html">glance</a></span>(.<span class="op">$</span>kclust[[<span class="dv">1</span>]]))</code></pre></div>
<p>Now we can plot the original points, with each point colored according to the original cluster:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p1 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(assignments, <span class="kw">aes</span>(x1, x2)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color=</span>.cluster)) <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>k)
p1</code></pre></div>
<p><img src="kmeans_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>Already we get a good sense of the proper number of clusters (3), and how the k-means algorithm functions when k is too high or too low. We can then add the centers of the cluster using the data from <code>tidy</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p2 &lt;-<span class="st"> </span>p1 <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">data=</span>clusters, <span class="dt">size=</span><span class="dv">10</span>, <span class="dt">shape=</span><span class="st">"x"</span>)
p2</code></pre></div>
<p><img src="kmeans_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>The data from <code>glance</code> fits a different but equally important purpose: it lets you view trends of some summary statistics across values of k. Of particular interest is the total within sum of squares, saved in the <code>tot.withinss</code> column.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(clusterings, <span class="kw">aes</span>(k, tot.withinss)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</code></pre></div>
<p><img src="kmeans_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>This represents the variance within the clusters. It decreases as k increases, but one can notice a bend (or “elbow”) right at k=3. This bend indicates that additional clusters beyond the third have little value. (See <a href="http://web.stanford.edu/~hastie/Papers/gap.pdf">here</a> for a more mathematically rigorous interpretation and implementation of this method). Thus, all three methods of tidying data provided by broom are useful for summarizing clustering output.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#tidying-k-means-clustering">Tidying k-means clustering</a><ul class="nav nav-pills nav-stacked">
<li><a href="#broom-and-dplyr-for-exploratory-clustering">broom and dplyr for exploratory clustering</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="tidyverse">
  <p>broom is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="http://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>Developed by David Robinson.</p>
  <p>Site built by <a href="http://pkgdown.r-lib.org">pkgdown</a>.</p>
</div>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-115082821-1');
</script></footer>
</div>

  

  </body>
</html>
